<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raport</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8f9fa; }
    .card { border:0; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.08); }
    .muted { color:#6c757d; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table-sm td, .table-sm th { padding: .35rem .5rem; }
  </style>
</head>
<body>
  <div class="container py-4">

    <div class="d-flex flex-wrap align-items-end justify-content-between mb-3">
      <div>
        <h3 class="mb-0">Raport <span id="reportId" class="mono"></span></h3>
        <div class="muted">Wygenerowano: <span id="createdAt">...</span></div>
      </div>
      <div class="mt-2">
        <button class="btn btn-outline-secondary btn-sm" onclick="window.location.reload()">Odśwież</button>
      </div>
    </div>

    <div id="loading" class="alert alert-info">Ładowanie raportu…</div>
    <div id="error" class="alert alert-danger d-none"></div>

    <div id="content" class="d-none">

      <!-- Metryki -->
      <div class="row g-3 mb-3">
        <div class="col-6 col-lg-3">
          <div class="card p-3">
            <div class="muted">Wszystkie leady</div>
            <div class="fs-3 fw-bold" id="mTotal">0</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card p-3">
            <div class="muted">Dobre</div>
            <div class="fs-3 fw-bold text-success" id="mGood">0</div>
            <div class="muted" id="mGoodPct">0%</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card p-3">
            <div class="muted">Średnie</div>
            <div class="fs-3 fw-bold text-warning" id="mMedium">0</div>
            <div class="muted" id="mMediumPct">0%</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card p-3">
            <div class="muted">Złe</div>
            <div class="fs-3 fw-bold text-danger" id="mBad">0</div>
            <div class="muted" id="mBadPct">0%</div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <!-- Wykres jakości -->
        <div class="col-lg-4">
          <div class="card p-3">
            <div class="fw-semibold mb-2">Rozkład jakości</div>
            <canvas id="qualityDonut" height="220"></canvas>
          </div>
        </div>

        <!-- Wykres w czasie -->
        <div class="col-lg-8">
          <div class="card p-3">
            <div class="fw-semibold mb-2">Jakość w czasie (miesiące)</div>
            <canvas id="qualityLine" height="220"></canvas>
          </div>
        </div>

        <!-- Tabele -->
        <div class="col-lg-6">
          <div class="card p-3">
            <div class="fw-semibold mb-2">Top rodzaje</div>
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead>
                  <tr><th>Rodzaj</th><th class="text-end">Liczba</th><th class="text-end">%</th></tr>
                </thead>
                <tbody id="topTypes"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card p-3">
            <div class="fw-semibold mb-2">Top kampanie (wg wolumenu)</div>
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead>
                  <tr><th>Kampania</th><th class="text-end">Razem</th><th class="text-end">% dobrych</th></tr>
                </thead>
                <tbody id="topCampaigns"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

      <div class="mt-3 muted small">
        Uwaga: ten widok pokazuje wyłącznie dane zagregowane (bez danych kontrahentów), o ile backend zapisuje tylko agregaty.
      </div>
    </div>
  </div>

<script>
  const id = window.location.pathname.split('/').filter(Boolean).pop();
  document.getElementById('reportId').textContent = id || '(brak)';

  function fmt(n){ return (n ?? 0).toLocaleString('pl-PL'); }
  function pct(a,t){ return t ? ((a/t)*100).toFixed(1) + '%' : '0.0%'; }

  let charts = {};

  function destroyCharts(){
    Object.values(charts).forEach(c => c && c.destroy && c.destroy());
    charts = {};
  }

  function renderTables(aggr){
    const total = aggr.totalRows || 0;

    // Top rodzaje
    const types = Object.entries(aggr.typeCounts || {})
      .sort((a,b)=>b[1]-a[1])
      .slice(0, 10);

    document.getElementById('topTypes').innerHTML = types.map(([name,count]) => `
      <tr>
        <td title="${name}">${name.length > 50 ? name.slice(0,50)+'…' : name}</td>
        <td class="text-end">${fmt(count)}</td>
        <td class="text-end">${pct(count,total)}</td>
      </tr>
    `).join('');

    // Top kampanie wg wolumenu + % dobrych
    const qbc = aggr.qualityByCampaign || {};
    const camps = Object.entries(qbc).map(([campaign, q]) => {
      const good = q['dobry']||0, med = q['średni']||0, bad = q['zły']||0, none = q['brak przypisania']||0;
      const sum = good+med+bad+none;
      const goodPct = sum ? (good/sum*100) : 0;
      return { campaign, sum, goodPct };
    }).sort((a,b)=>b.sum-a.sum).slice(0, 10);

    document.getElementById('topCampaigns').innerHTML = camps.map(c => `
      <tr>
        <td title="${c.campaign}">${c.campaign.length > 50 ? c.campaign.slice(0,50)+'…' : c.campaign}</td>
        <td class="text-end">${fmt(c.sum)}</td>
        <td class="text-end ${c.goodPct >= 50 ? 'text-success' : 'text-danger'}">${c.goodPct.toFixed(1)}%</td>
      </tr>
    `).join('');
  }

  function renderCharts(aggr, chartsData){
    destroyCharts();

    const total = aggr.totalRows || 0;
    const qc = aggr.qualityCounts || {};
    const good = qc['dobry']||0;
    const medium = qc['średni']||0;
    const bad = qc['zły']||0;
    const none = qc['brak przypisania']||0;

    // Donut jakości
    const donutCtx = document.getElementById('qualityDonut');
    charts.qualityDonut = new Chart(donutCtx, {
      type: 'doughnut',
      data: {
        labels: ['Dobre', 'Średnie', 'Złe', 'Brak przypisania'],
        datasets: [{ data: [good, medium, bad, none] }]
      },
      options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });

    // Line jakości po miesiącach
    const byMonth = (chartsData && chartsData.qualityByMonth) ? chartsData.qualityByMonth : (aggr.qualityByMonth || {});
    const months = Object.keys(byMonth).sort();
    const labels = months.map(m => {
      const [y,mo]=m.split('-');
      const names=['Sty','Lut','Mar','Kwi','Maj','Cze','Lip','Sie','Wrz','Paź','Lis','Gru'];
      return `${names[parseInt(mo,10)-1]} ${y}`;
    });

    const goodArr = months.map(m => (byMonth[m]?.['dobry']||0));
    const medArr  = months.map(m => (byMonth[m]?.['średni']||0));
    const badArr  = months.map(m => (byMonth[m]?.['zły']||0));

    const lineCtx = document.getElementById('qualityLine');
    charts.qualityLine = new Chart(lineCtx, {
      type:'line',
      data:{
        labels,
        datasets:[
          { label:'Dobre', data: goodArr, tension:.15, fill:true },
          { label:'Średnie', data: medArr, tension:.15, fill:true },
          { label:'Złe', data: badArr, tension:.15, fill:true }
        ]
      },
      options:{
        responsive:true,
        plugins:{ legend:{ position:'bottom' } },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  }

  async function load(){
    try{
      const res = await fetch(`/api/reports/${id}`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const report = await res.json();

      document.getElementById('loading').classList.add('d-none');
      document.getElementById('content').classList.remove('d-none');

      document.getElementById('createdAt').textContent = report.createdAt ? new Date(report.createdAt).toLocaleString('pl-PL') : '—';

      const aggr = report.aggregatedData || {};
      const qc = aggr.qualityCounts || {};
      const total = aggr.totalRows || 0;

      const good = qc['dobry']||0;
      const medium = qc['średni']||0;
      const bad = qc['zły']||0;

      document.getElementById('mTotal').textContent = fmt(total);
      document.getElementById('mGood').textContent = fmt(good);
      document.getElementById('mMedium').textContent = fmt(medium);
      document.getElementById('mBad').textContent = fmt(bad);

      document.getElementById('mGoodPct').textContent = pct(good,total);
      document.getElementById('mMediumPct').textContent = pct(medium,total);
      document.getElementById('mBadPct').textContent = pct(bad,total);

      renderTables(aggr);
      renderCharts(aggr, report.chartsData || {});
    }catch(e){
      document.getElementById('loading').classList.add('d-none');
      const el = document.getElementById('error');
      el.classList.remove('d-none');
      el.textContent = `Nie udało się wczytać raportu: ${e.message}`;
    }
  }

  load();
</script>
</body>
</html>
